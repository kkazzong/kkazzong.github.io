<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="replyDB">

	<select id="getReplyAll" parameterType="int" resultType="ReplyOutputDto">
		with recursive CTE as (
		    select
				p.reply_no,
		        p.reply,
		        p.origin_no,
		        p.reply_depth,
		        p.reply_name,
		        p.write_dt,
		        cast(reply_no as char(100)) lvl
		    from kka_reply p
		    where p.board_no = #{board_no} and p.origin_no = 0
		    union all
		    select
				r.reply_no,
		        r.reply,
		        r.origin_no,
		        r.reply_depth,
		        r.reply_name,
		        r.write_dt,
		        concat(c.lvl, ",", r.reply_no) lvl
		    from kka_reply r
		    inner join CTE c
		    on r.origin_no = c.reply_no
		    where r.board_no = #{board_no}
		)
		select
			cc.reply_no,
			cc.reply,
			cc.origin_no,
			cc.reply_depth,
			cc.reply_name,
			date_format(cc.write_dt, '%Y-%m-%d : %H:%i') as write_dt,
		    cc.lvl
		from CTE cc
		order by cc.lvl
	</select>
	
	<insert id="addReply" parameterType="ReplyInputDto">
		insert into kka_reply
			(
				board_no,
				reply,
				reply_name,
				origin_no,
				reply_depth
			)
		values
			(
				#{board_no},
				#{reply},
				#{reply_name},
				#{origin_no},
				#{reply_depth}
			)
	</insert>
</mapper>
